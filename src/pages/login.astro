---
// src/pages/login.astro
import Layout from "../layouts/Layout.astro";

// This page handles both displaying the form (GET) and processing the login (POST).
let error: string | null = null;

if (Astro.request.method === "POST") {
    try {
        const formData = await Astro.request.formData();
        const user = formData.get("username");
        const pass = formData.get("password");

        // --- Hardcoded credentials ---
        const ADMIN_USER = "cobaires";
        const ADMIN_PASS = "cobairesadmin";

        if (user === ADMIN_USER && pass === ADMIN_PASS) {
            // Credentials are correct. Set a session cookie.
            // This cookie will be used to verify access to the dashboard.
            Astro.cookies.set('session-token', 'user-is-logged-in', {
                path: '/',
                httpOnly: true, // Makes the cookie inaccessible to client-side JS
                maxAge: 60 * 60 * 24 // Expires in 1 day
            });
            // Redirect to the dashboard
            return Astro.redirect('/admin');
        } else {
            // Credentials are wrong.
            error = "Usuario o contraseña incorrectos.";
        }
    } catch (e) {
        error = "Ocurrió un error al intentar iniciar sesión.";
        console.error(e);
    }
}
---
<Layout title="Login - Dashboard">
    <main class="min-h-screen flex items-center justify-center px-4">
        <div class="max-w-md w-full lg:max-w-md bg-white rounded-2xl shadow-lg p-8">
            <div class="text-center mb-8">
                <img src="/iso-black.svg" class="h-16 mx-auto mb-4" alt="Cobaires Logo" />
                <h1 class="text-3xl font-bold text-gray-800">Acceso al Panel</h1>
                <p class="text-gray-500 mt-2">Ingresá tus credenciales para continuar.</p>
            </div>

            <form method="POST" class="space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">
                        Usuario
                    </label>
                    <input
                        type="text"
                        name="username"
                        id="username"
                        required
                        class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-[#666695] focus:border-[#666695] sm:text-sm"
                        placeholder="cobaires"
                    />
                </div>

                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">
                        Contraseña
                    </label>
                    <input
                        type="password"
                        name="password"
                        id="password"
                        required
                        class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-[#666695] focus:border-[#666695] sm:text-sm"
                        placeholder="••••••••"
                    />
                </div>

                {error && (
                    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg" role="alert">
                        <p>{error}</p>
                    </div>
                )}

                <div>
                    <button
                        type="submit"
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-base font-medium text-white bg-[#666695] hover:brightness-90 transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#55557d]"
                    >
                        Ingresar
                    </button>
                </div>
            </form>
        </div>
    </main>
</Layout>
