---
// src/pages/proyectos/[id].astro
import Layout from "../layouts/Layout.astro";
import Header from "../components/sections/Nosotros/Header.astro";
import { PrismaClient } from "@prisma/client";

// --- FIX: This line switches the page from static (SSG) to dynamic (SSR) ---
// It tells Astro to generate this page on the server for every request,
// ensuring it can find newly created projects without needing a rebuild.
export const prerender = false;

const prisma = new PrismaClient();

// NOTE: The getStaticPaths function has been removed because this is now a
// server-rendered page. It will dynamically handle any project ID.

// Get the specific project data for this page using the ID from the URL.
const { id } = Astro.params;
const project = await prisma.project.findUnique({
    where: { id: Number(id) },
    // We use 'include' to also fetch the related images for the carousel.
    include: {
        images: {
            orderBy: {
                id: "asc", // Ensure images are always in a consistent order
            },
        },
    },
});

// Prepare the image URLs for the client-side carousel script.
const imageUrls = project.images.map((img) => img.url);
---

<Layout>
    <Header />

    <section
        class="px-4 md:px-4 lg:px-0 lg:max-w-7xl w-full mx-auto flex flex-col gap-11 py-12"
    >
        <!-- Carousel Section -->
        <div id="carousel-container" class="relative overflow-hidden">
            <!-- The image now loads the first URL from our dynamic list -->
            <img
                id="carousel-image"
                src={imageUrls[0] || "/placeholder.png"}
                class="h-[600px] w-full rounded-2xl object-cover select-none cursor-grab active:cursor-grabbing"
                alt={`Imagen principal del proyecto: ${project.title}`}
            />
            <!-- Dots Navigation -->
            <div
                id="carousel-dots"
                class="flex justify-center items-center gap-3 mt-6"
            >
                <!-- Dots are generated by the script -->
            </div>
        </div>

        <div
            class="px-4 lg:px-0 lg:max-w-4xl mx-auto flex flex-col w-full gap-11"
        >
            <!-- Project Title is now dynamic -->
            <h2 class="font-medium text-3xl text-[#051314]">
                {project.title}
            </h2>

            <!-- Project Description is now dynamic -->
            <p class="text-gray-700 leading-relaxed whitespace-pre-line">
                {project.description}
            </p>

            <!-- Project Details list is now dynamic, with conditional rendering for optional fields -->
            <ul class="flex flex-col gap-4 mb-20">
                <li
                    class="border-b border-black grid grid-cols-[180px_1fr] gap-x-6 py-3"
                >
                    <span class="text-lg font-semibold text-[#051314]"
                        >Proyecto</span
                    >
                    <p class="text-lg font-light text-[#051314]">
                        {project.title}
                    </p>
                </li>
                {
                    project.type && (
                        <li class="border-b border-black grid grid-cols-[180px_1fr] gap-x-6 py-3">
                            <span class="text-lg font-semibold text-[#051314]">
                                Tipo
                            </span>
                            <p class="text-lg font-light text-[#051314]">
                                {project.type}
                            </p>
                        </li>
                    )
                }
                {
                    project.location && (
                        <li class="border-b border-black grid grid-cols-[180px_1fr] gap-x-6 py-3">
                            <span class="text-lg font-semibold text-[#051314]">
                                Locación
                            </span>
                            <p class="text-lg font-light text-[#051314]">
                                {project.location}
                            </p>
                        </li>
                    )
                }
                {
                    project.year && (
                        <li class="border-b border-black grid grid-cols-[180px_1fr] gap-x-6 py-3">
                            <span class="text-lg font-semibold text-[#051314]">
                                Año
                            </span>
                            <p class="text-lg font-light text-[#051314]">
                                {project.year}
                            </p>
                        </li>
                    )
                }
                {
                    project.surface && (
                        <li class="border-b border-black grid grid-cols-[180px_1fr] gap-x-6 py-3">
                            <span class="text-lg font-semibold text-[#051314]">
                                Superficie
                            </span>
                            <p class="text-lg font-light text-[#051314]">
                                {project.surface}
                            </p>
                        </li>
                    )
                }
                {
                    project.client && (
                        <li class="border-b border-black grid grid-cols-[180px_1fr] gap-x-6 py-3">
                            <span class="text-lg font-semibold text-[#051314]">
                                Cliente
                            </span>
                            <p class="text-lg font-light text-[#051314]">
                                {project.client}
                            </p>
                        </li>
                    )
                }
            </ul>
        </div>
    </section>
</Layout>

<script define:vars={{ imageUrls }}>
    // --- Carousel Logic ---
    document.addEventListener("DOMContentLoaded", () => {
        // Use the dynamic image URLs passed from the server
        const images = imageUrls;

        if (!images || images.length === 0) {
            console.warn("No images found for carousel.");
            return;
        }

        const carouselContainer = document.getElementById("carousel-container");
        const carouselImage = document.getElementById("carousel-image");
        const dotsContainer = document.getElementById("carousel-dots");

        if (!carouselContainer || !carouselImage || !dotsContainer) return;

        let currentIndex = 0;
        let isDragging = false;
        let startPos = 0;
        let currentTranslate = 0;

        const updateCarousel = () => {
            carouselImage.src = images[currentIndex];
            carouselImage.alt = `Imagen del carrusel ${currentIndex + 1}`;

            const dots = dotsContainer.children;
            for (let i = 0; i < dots.length; i++) {
                const dot = dots[i];
                dot.classList.remove("bg-[#051314]", "w-8");
                dot.classList.add("bg-gray-300", "w-3");
            }
            dots[currentIndex]?.classList.add("bg-[#051314]", "w-8");
            dots[currentIndex]?.classList.remove("bg-gray-300", "w-3");
        };

        images.forEach((_, index) => {
            const dot = document.createElement("button");
            dot.classList.add(
                "h-3",
                "rounded-full",
                "transition-all",
                "duration-300",
                "ease-in-out",
            );
            dot.setAttribute("aria-label", `Ir a la imagen ${index + 1}`);
            dot.addEventListener("click", () => {
                currentIndex = index;
                updateCarousel();
            });
            dotsContainer.appendChild(dot);
        });

        const dragStart = (event) => {
            isDragging = true;
            startPos =
                "touches" in event ? event.touches[0].clientX : event.clientX;
            event.preventDefault();
        };

        const dragging = (event) => {
            if (!isDragging) return;
            const currentPosition =
                "touches" in event ? event.touches[0].clientX : event.clientX;
            currentTranslate = currentPosition - startPos;
        };

        const dragEnd = () => {
            if (!isDragging) return;
            isDragging = false;
            const movedBy = currentTranslate;
            if (movedBy < -50 && currentIndex < images.length - 1) {
                currentIndex++;
            }
            if (movedBy > 50 && currentIndex > 0) {
                currentIndex--;
            }
            updateCarousel();
            currentTranslate = 0;
        };

        carouselContainer.addEventListener("mousedown", dragStart);
        carouselContainer.addEventListener("touchstart", dragStart, {
            passive: true,
        });
        carouselContainer.addEventListener("mouseup", dragEnd);
        carouselContainer.addEventListener("touchend", dragEnd);
        carouselContainer.addEventListener("mouseleave", dragEnd);
        carouselContainer.addEventListener("mousemove", dragging);
        carouselContainer.addEventListener("touchmove", dragging, {
            passive: true,
        });

        updateCarousel();
    });
</script>
