---
// src/pages/dashboard/proyectos/index.astro
import Layout from "../../layouts/Layout.astro"; // Adjust path as needed
import { PrismaClient } from "@prisma/client";

const prisma = new PrismaClient();

// Fetch all projects directly on the server when the page is built/rendered.
const projects = await prisma.project.findMany({
    orderBy: {
        createdAt: "desc",
    },
});
---

<Layout title="Dashboard - Proyectos">
    <main class="bg-gray-50 min-h-screen p-4 sm:p-6 lg:p-8">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="flex justify-between items-center mb-10">
                <div>
                    <h1 class="text-4xl font-bold text-gray-800">Proyectos</h1>
                    <p class="text-lg text-gray-500">
                        Administrá los proyectos del portfolio.
                    </p>
                </div>
                <a
                    href="/dashboard/proyectos/nuevo"
                    class="inline-flex items-center justify-center py-2 px-5 border border-transparent shadow-sm text-base font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 transition"
                >
                    <svg
                        class="-ml-1 mr-2 h-5 w-5"
                        xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 20 20"
                        fill="currentColor"
                        aria-hidden="true"
                        ><path
                            fill-rule="evenodd"
                            d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
                            clip-rule="evenodd"></path></svg
                    >
                    Añadir Proyecto
                </a>
            </div>

            <!-- Projects Table -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    scope="col"
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                    >Imagen</th
                                >
                                <th
                                    scope="col"
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                    >Título</th
                                >
                                <th
                                    scope="col"
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                    >Año</th
                                >
                                <th
                                    scope="col"
                                    class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider"
                                    >Acciones</th
                                >
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {
                                projects.map((project) => (
                                    <tr id={`project-row-${project.id}`}>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <img
                                                src={project.imageUrl}
                                                alt={project.title}
                                                class="h-10 w-16 object-cover rounded-md"
                                            />
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-medium text-gray-900">
                                                {project.title}
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm text-gray-500">
                                                {project.year}
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            <a
                                                href={`/dashboard/proyectos/editar/${project.id}`}
                                                class="text-blue-600 hover:text-blue-900"
                                            >
                                                Editar
                                            </a>
                                            <button
                                                data-project-id={project.id}
                                                class="delete-button text-red-600 hover:text-red-900 ml-4"
                                            >
                                                Eliminar
                                            </button>
                                        </td>
                                    </tr>
                                ))
                            }
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Status Message Area -->
            <div id="status-message" class="mt-6 text-center"></div>
        </div>
    </main>
</Layout>

<script>
    const deleteButtons = document.querySelectorAll(".delete-button");
    const statusMessage = document.getElementById("status-message");

    deleteButtons.forEach((button) => {
        button.addEventListener("click", async (e) => {
            const projectId = e.target.dataset.projectId;

            if (
                !confirm(
                    "¿Estás seguro de que querés eliminar este proyecto? Esta acción no se puede deshacer.",
                )
            ) {
                return;
            }

            try {
                const response = await fetch(`/api/projects/${projectId}`, {
                    method: "DELETE",
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(
                        result.message || "No se pudo eliminar el proyecto.",
                    );
                }

                // Remove the project row from the table
                const row = document.getElementById(`project-row-${projectId}`);
                if (row) {
                    row.remove();
                }

                statusMessage.textContent = "¡Proyecto eliminado con éxito!";
                statusMessage.className = "mt-6 text-center text-green-600";
            } catch (error) {
                statusMessage.textContent = error.message;
                statusMessage.className = "mt-6 text-center text-red-600";
            }
        });
    });
</script>
