---
// src/pages/proyectos/index.astro
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import SecondHeader from "../components/SecondHeader.astro";
import { PrismaClient } from "@prisma/client";

export const prerender = false;

const prisma = new PrismaClient();

const projects = await prisma.project.findMany({
  orderBy: {
    createdAt: "desc",
  },
  include: {
    images: true,
  },
});
---

<Layout>
  <div class="block lg:hidden">
    <Header />
  </div>

  <div class="hidden lg:block">
    <SecondHeader />
  </div>

  <section class="px-4 py-12 lg:px-0">
    <header class="mx-auto mb-12 max-w-7xl space-y-4">
      <h2 class="text-3xl font-medium text-[#051314]">Conocé nuestras obras</h2>
      <p class="text-xl text-[#051314]">
        Cada proyecto cuenta una historia: hospitales que cuidan, escuelas que
        inspiran, espacios que conectan. En esta sección, explorá nuestras obras
        más destacadas, que combinan estética y funcionalidad.
      </p>
    </header>

    <section
      class="mx-auto grid max-w-7xl grid-cols-1 gap-8 md:grid-cols-2 md:gap-10 lg:grid-cols-3"
    >
      {
        projects.map((project) => (
          // We add "project-card" for the script to find it
          <article class="project-card group relative h-96 w-full cursor-pointer overflow-hidden rounded-2xl p-4 shadow-lg">

            <div
              class="absolute inset-0 bg-cover bg-center transition-transform duration-500 ease-in-out scale-110 group-hover:scale-100 group-[.is-active]:scale-100"
              style={`background-image: url('${project.images.find((e) => e.isThumbnail).url}')`}
            />

            <div
              class="absolute bottom-4 left-4 right-4 flex flex-col justify-end rounded-lg bg-[#666695] p-4 text-white opacity-0 translate-y-8 transition-all duration-100 ease-in-out group-hover:opacity-100 group-hover:translate-y-0 group-[.is-active]:opacity-100 group-[.is-active]:translate-y-0"
            >
              <h3 class="truncate text-xl font-bold">{project.title}</h3>
              <span class="text-sm text-white/80">
                Proyección y Dirección
              </span>
              <div class="mt-4 flex items-center justify-between">
                <small>{project.location}</small>
                <a
                  href={`/${project.id}`}
                  class="border border-white rounded-full px-4 py-1.5 text-sm transition-colors whitespace-nowrap hover:bg-white hover:text-[#666695]"
                >
                  Ver más
                </a>
              </div>
            </div>
          </article>
        ))
      }
    </section>
  </section>
</Layout>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const projectCards = document.querySelectorAll(".project-card");

    const deactivateAllCards = () => {
      projectCards.forEach((card) => {
        card.classList.remove("is-active");
      });
    };

    projectCards.forEach((card) => {
      card.addEventListener("click", (event) => {
        const wasActive = card.classList.contains("is-active");

        // First, deactivate all cards
        deactivateAllCards();

        // If the card was not active, activate it now
        if (!wasActive) {
          card.classList.add("is-active");
        }

        // Prevent click from bubbling up to the document and closing the card
        event.stopPropagation();
      });
    });

    // Listener to close cards when clicking anywhere else on the page
    document.addEventListener("click", () => {
      deactivateAllCards();
    });
  });
</script>
